- name: YUM | RHEL7 add CentOS7 repo
  become: true
  ansible.builtin.yum_repository:
    name: centos
    description: CenOS7 repo
    baseurl: http://ftp.heanet.ie/pub/centos/7/os/x86_64/
    gpgcheck: true
    gpgkey: http://ftp.heanet.ie/pub/centos/7/os/x86_64/RPM-GPG-KEY-CentOS-7
  when:
    - ansible_distribution == 'RedHat'
    - ansible_distribution_major_version|int == 7

- name: YUM | RHEL8 add CentOS8 Appstream repo
  become: true
  ansible.builtin.yum_repository:
    name: appstream
    description: CentOS 8 AppStream repo
    baseurl: http://vault.centos.org/centos/8/AppStream/x86_64/os/
    gpgcheck: true
    gpgkey: https://www.centos.org/keys/RPM-GPG-KEY-CentOS-Official
  when:
    - ansible_distribution == 'RedHat'
    - ansible_distribution_major_version|int == 8


- name: CentOS 8 | fix repos
  import_tasks: centos8-repo-fix.yml
  when:
    - ansible_distribution == 'CentOS'
    - ansible_distribution_major_version == '8'
    - ansible_distribution_release == 'NA' #ensures not to execute on CentOS 8 Stream
  tags: fixrepos

- name: Install git, curl and python3
  become: true
  ansible.builtin.yum:
    name:
      - git
      - curl
      - python3
    state: present
  when: ansible_os_family == 'RedHat'


  # https://asdf-vm.com/guide/getting-started.html#official-download
- name: ASDF | install from git
  ansible.builtin.git:
    repo: 'https://github.com/asdf-vm/asdf.git'
    dest: $HOME/.asdf
    version: v0.11.2

- name: ASDF | Setup in bashrc
  ansible.builtin.lineinfile:
    path: .bashrc
    line: "source \"$HOME/.asdf/asdf.sh\""

- name: ASDF | test
  ansible.builtin.shell: "asdf"
  changed_when: false

- name: Crate $HOME/.tool-versions with ansible
  ansible.builtin.lineinfile:
    create: true
    path: .tool-versions
    line: "ansible-base 2.10.17"

- name: ASDF | add plugin ansible-base
  changed_when: false
  ansible.builtin.shell: "asdf plugin add ansible-base || true"
  register: asdf_plugin

- debug:
    msg: "{{ asdf_plugin.stdout_lines }}"

- name: ASDF | install ansible-base
  changed_when: false
  ansible.builtin.shell: "asdf install ansible-base || true"
  register: asdf_install

- debug:
    msg: "{{ asdf_install.stdout_lines }}"


- name: ASDF | test ansible
  ansible.builtin.shell: "ansible --version"
  register: ansible

- name: Show ansible
  debug:
    msg: "{{ ansible.stdout_lines }}"
